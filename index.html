<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Agenda Onicotecnica - Premium PWA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#030616" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Agenda Nails" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root {
      --bg: #030616;
      --bg-soft: #05091f;
      --bg-elevated: #0b1027;
      --accent: #f97316;            /* arancio premium */
      --accent-soft: rgba(249,115,22,0.14);
      --accent-strong: #ea580c;
      --accent-2: #22c55e;          /* verde conferme */
      --accent-3: #38bdf8;          /* azzurro info */
      --text: #f9fafb;
      --text-soft: #a5b4fc;
      --border: #111827;
      --danger: #f97373;
      --radius-lg: 18px;
      --radius-xl: 26px;
      --shadow-soft: 0 22px 55px rgba(0,0,0,0.8);
      --shadow-subtle: 0 10px 25px rgba(15,23,42,0.7);
      --nav-height: 62px;
      --header-height: 60px;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      -webkit-tap-highlight-color: transparent;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
    }

    body {
      background:
        radial-gradient(circle at top left, #1e1b4b 0, transparent 55%),
        radial-gradient(circle at bottom right, #0f172a 0, transparent 55%),
        linear-gradient(160deg, #020617 0%, #020617 40%, #030616 100%);
      color: var(--text);
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      align-items:stretch;
    }

    .app-shell {
      position: relative;
      min-height: 100vh;
      padding-bottom: calc(var(--nav-height) + 16px);
      padding-top: calc(var(--header-height) + 8px);
    }

    /* Header mobile fixed */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      padding: 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      backdrop-filter: blur(18px);
      background: linear-gradient(90deg, rgba(15,23,42,0.95), rgba(3,7,18,0.9));
      border-bottom:1px solid rgba(15,23,42,0.95);
      z-index: 30;
    }
    .brand-main {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-title {
      font-size:0.98rem;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .brand-pill {
      font-size:.64rem;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(248,250,252,0.18);
      background:linear-gradient(135deg,rgba(15,23,42,0.95),rgba(30,64,175,0.7));
      color:#e5e7eb;
    }
    .brand-sub {
      font-size:.72rem;
      color:var(--text-soft);
      display:flex;
      gap:6px;
      align-items:center;
    }
    .brand-dot {
      width:7px;height:7px;border-radius:999px;
      background:conic-gradient(from 120deg,#f97316,#22c55e,#38bdf8,#f97316);
      box-shadow:0 0 0 4px rgba(249,115,22,0.35);
    }
    .header-badge {
      font-size:.7rem;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.9);
      display:flex;
      align-items:center;
      gap:6px;
      color:var(--text-soft);
    }
    .header-badge-dot {
      width:6px;height:6px;border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 4px rgba(22,163,74,0.35);
    }

    /* Bottom nav mobile */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--nav-height);
      padding: 8px 14px 10px;
      background: radial-gradient(circle at top, rgba(30,64,175,0.4), transparent 55%),
                  linear-gradient(180deg, rgba(15,23,42,0.98), rgba(3,7,18,0.98));
      border-top: 1px solid rgba(15,23,42,0.98);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      z-index:30;
    }
    .nav-btn {
      flex:1;
      border:none;
      border-radius:999px;
      padding:6px 8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
      background:transparent;
      color:var(--text-soft);
      font-size:.68rem;
      letter-spacing:.04em;
      text-transform:uppercase;
      cursor:pointer;
      transition:transform .16s, background .16s, box-shadow .16s, color .16s;
    }
    .nav-btn-icon {
      font-size:1rem;
    }
    .nav-btn.active {
      background: radial-gradient(circle at top, rgba(249,115,22,0.2), transparent 55%),
                  linear-gradient(135deg, var(--accent), var(--accent-strong));
      color:#0b1020;
      box-shadow:0 12px 26px rgba(0,0,0,0.75);
      transform: translateY(-1px);
    }

    /* Content area */
    .page {
      padding: 0 14px 14px;
      max-width: 960px;
      margin: 0 auto;
    }

    .section-title-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      gap:8px;
    }
    .section-title-main {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .section-title-main h2 {
      font-size:0.94rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#e5e7eb;
    }
    .section-title-main span {
      font-size:.76rem;
      color:var(--text-soft);
    }
    .section-chip {
      font-size:.65rem;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.4);
      background:rgba(15,23,42,0.9);
      color:var(--text-soft);
    }

    .card {
      background: radial-gradient(circle at top left, rgba(30,64,175,0.3), transparent 65%),
                  radial-gradient(circle at bottom right, rgba(249,115,22,0.33), transparent 60%),
                  linear-gradient(145deg, rgba(3,7,18,0.96), rgba(15,23,42,0.98));
      border-radius: var(--radius-lg);
      padding: 12px 12px 10px;
      border: 1px solid rgba(30,64,175,0.8);
      box-shadow: var(--shadow-subtle);
      margin-bottom: 12px;
      position:relative;
    }
    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      gap:8px;
    }
    .card-title {
      font-size:.86rem;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-title-pill {
      font-size:.6rem;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.35);
      background:rgba(15,23,42,0.85);
      color:var(--text-soft);
    }
    .muted {
      font-size:.74rem;
      color:var(--text-soft);
    }

    /* Form layout optimized mobile */
    form {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:8px;
    }
    .field-row-2 {
      display:flex;
      gap:8px;
    }
    .field-row-2 > div {
      flex:1;
    }
    label {
      display:block;
      font-size:.68rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--text-soft);
      margin-bottom:3px;
    }
    input, select, textarea {
      width:100%;
      padding:7px 9px;
      border-radius: 11px;
      border:1px solid rgba(30,64,175,0.8);
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(2,6,23,0.98));
      color:var(--text);
      font-size:.8rem;
      outline:none;
      transition:border-color .16s, box-shadow .16s, background .16s, transform .12s;
    }
    input:focus, select:focus, textarea:focus {
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(249,115,22,0.6);
      transform:translateY(-0.5px);
    }
    textarea {
      resize:vertical;
      min-height:70px;
    }

    .actions-row {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-end;
      margin-top:4px;
    }
    .btn-sm {
      border-radius:999px;
      border:1px solid rgba(30,64,175,0.9);
      background:rgba(15,23,42,0.96);
      padding:7px 11px;
      font-size:.74rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--text-soft);
      cursor:pointer;
      transition:background .16s, transform .12s, box-shadow .16s, border-color .16s;
    }
    .btn-sm span.icon {
      font-size:.86rem;
    }
    .btn-sm.primary {
      border-color:transparent;
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#0f172a;
      box-shadow:0 10px 24px rgba(249,115,22,0.48);
    }
    .btn-sm.soft {
      border-color:rgba(129,140,248,0.5);
      background:rgba(15,23,42,0.98);
    }
    .btn-sm.danger {
      border-color:rgba(248,113,113,0.9);
      color:#fecaca;
    }
    .btn-sm:active {
      transform:translateY(1px);
      box-shadow:none;
    }

    /* Tables -> scroll cards on mobile */
    .table-wrapper {
      margin-top:6px;
      border-radius: 14px;
      border:1px solid rgba(30,64,175,0.9);
      background: radial-gradient(circle at top, rgba(15,23,42,0.88), rgba(3,7,18,0.98));
      max-height: 260px;
      overflow:auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(129,140,248,0.8) transparent;
    }
    .table-wrapper::-webkit-scrollbar {
      height:6px;
      width:6px;
    }
    .table-wrapper::-webkit-scrollbar-thumb {
      background:rgba(129,140,248,0.9);
      border-radius:999px;
    }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:.78rem;
    }
    thead {
      position:sticky;
      top:0;
      z-index:1;
      background:linear-gradient(135deg,rgba(15,23,42,0.98),rgba(15,23,42,0.96));
    }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid rgba(15,23,42,0.95);
      white-space:nowrap;
    }
    th {
      font-size:.68rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--text-soft);
    }
    tbody tr:nth-child(even) {
      background:rgba(15,23,42,0.9);
    }
    tbody tr:hover {
      background:rgba(30,64,175,0.5);
    }

    .status-badge {
      font-size:.68rem;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(34,197,94,0.7);
      background:rgba(21,128,61,0.18);
      color:#bbf7d0;
    }
    .status-badge.pending {
      border-color:rgba(245,158,11,0.9);
      background:rgba(202,138,4,0.18);
      color:#fed7aa;
    }
    .status-badge.cancelled {
      border-color:rgba(248,113,113,0.9);
      background:rgba(127,29,29,0.3);
      color:#fecaca;
    }

    .badge-light {
      font-size:.7rem;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(129,140,248,0.6);
      color:var(--text-soft);
    }

    .report-card {
      margin-bottom:4px;
      padding:6px 8px;
      border-radius:11px;
      background:radial-gradient(circle at top left,rgba(30,64,175,0.45),transparent 55%),
                 linear-gradient(145deg,rgba(15,23,42,0.98),rgba(15,23,42,0.95));
      border:1px solid rgba(59,130,246,0.8);
      font-size:0.78rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .report-card span.value {
      font-weight:600;
      color:#fbbf24;
    }

    .summary-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .summary-box {
      flex:1;
      min-width:0;
      border-radius:14px;
      padding:7px 9px;
      background:radial-gradient(circle at top,rgba(249,115,22,0.22),transparent 60%),
                 linear-gradient(145deg,rgba(15,23,42,0.98),rgba(15,23,42,0.96));
      border:1px solid rgba(249,115,22,0.7);
      box-shadow:0 10px 24px rgba(0,0,0,0.6);
    }
    .summary-box h3 {
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--text-soft);
      margin-bottom:3px;
    }
    .summary-box .value {
      font-size:1.1rem;
      font-weight:700;
    }

    .summary-box.secondary {
      border-color:rgba(56,189,248,0.7);
      background:radial-gradient(circle at top,rgba(56,189,248,0.16),transparent 60%),
                 linear-gradient(145deg,rgba(15,23,42,0.98),rgba(15,23,42,0.96));
    }

    /* Calendar */
    .calendar-controls {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      align-items:flex-end;
    }
    .calendar-controls > div {
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .calendar-mode-toggle {
      display:flex;
      border-radius:999px;
      border:1px solid rgba(30,64,175,0.9);
      overflow:hidden;
      background:rgba(15,23,42,0.95);
    }
    .calendar-mode-toggle button {
      flex:1;
      border:none;
      padding:6px 10px;
      font-size:0.72rem;
      color:var(--text-soft);
      background:transparent;
      cursor:pointer;
    }
    .calendar-mode-toggle button.active {
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#020617;
    }
    .calendar-weekdays {
      display:grid;
      grid-template-columns:repeat(7,minmax(0,1fr));
      gap:4px;
      font-size:0.68rem;
      color:var(--text-soft);
      margin-top:4px;
      margin-bottom:2px;
      text-align:center;
    }
    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7,minmax(0,1fr));
      gap:4px;
      margin-top:6px;
    }
    .calendar-day {
      min-height:78px;
      border-radius:11px;
      border:1px solid rgba(30,64,175,0.85);
      background:radial-gradient(circle at top,rgba(15,23,42,0.92),rgba(2,6,23,0.98));
      padding:4px 5px;
      display:flex;
      flex-direction:column;
    }
    .calendar-day-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.68rem;
      margin-bottom:2px;
      color:var(--text-soft);
    }
    .calendar-day-header span.date {
      font-weight:600;
      color:#e5e7eb;
      font-size:0.7rem;
    }
    .calendar-day-body {
      flex:1;
      overflow:hidden;
    }
    .calendar-appointment {
      font-size:0.66rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-bottom:2px;
    }
    .calendar-appointment span.dot {
      display:inline-block;
      width:6px;height:6px;
      border-radius:999px;
      margin-right:4px;
      background:#22c55e;
    }

    /* Utilities */
    .hidden { display:none; }

    @media (min-width: 900px) {
      .page {
        padding: 8px 24px 16px;
      }
      .card {
        padding: 14px 16px 12px;
      }
      form {
        gap:10px;
      }
      .field-row-2 {
        display:flex;
      }
      .summary-bar {
        gap:16px;
      }
    }
  </style>
</head>
<body>
  <div class="app-header">
    <div class="brand-main">
      <div class="brand-title">
        <span>Agenda Nails ‚Ä¢ Studio Pro</span>
        <span class="brand-pill">Premium PWA</span>
      </div>
      <div class="brand-sub">
        <span class="brand-dot"></span>
        <span>Clienti ‚Ä¢ Appuntamenti ‚Ä¢ Report</span>
      </div>
    </div>
    <div class="header-badge">
      <span class="header-badge-dot"></span>
      <span>Dati solo sul dispositivo</span>
    </div>
  </div>

  <div class="app-shell">
    <div class="page" id="page-clienti">
      <div class="section-title-row">
        <div class="section-title-main">
          <h2>Clienti</h2>
          <span>Gestione anagrafiche, note e WhatsApp diretto.</span>
        </div>
        <span class="section-chip">Schede clienti</span>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span>Nuova scheda cliente</span>
              <span class="card-title-pill">Anagrafica</span>
            </div>
            <div class="muted">Compila i dati principali per creare o aggiornare un cliente.</div>
          </div>
        </div>
        <form id="client-form">
          <input type="hidden" id="client-id" />
          <div>
            <label for="client-name">Nome e cognome</label>
            <input type="text" id="client-name" placeholder="Es. Maria Rossi" required />
          </div>
          <div class="field-row-2">
            <div>
              <label for="client-phone">Telefono (WhatsApp)</label>
              <input type="tel" id="client-phone" placeholder="Es. 3931234567" required />
            </div>
            <div>
              <label for="client-email">Email</label>
              <input type="email" id="client-email" placeholder="Es. cliente@mail.com" />
            </div>
          </div>
          <div>
            <label for="client-address">Indirizzo</label>
            <input type="text" id="client-address" placeholder="Via, n¬∞, citt√† (facoltativo)" />
          </div>
          <div>
            <label for="client-last-service">Ultima prestazione</label>
            <input type="text" id="client-last-service" placeholder="Es. Refill gel, semipermanente..." />
          </div>
          <div>
            <label for="client-notes">Allergie / note</label>
            <textarea id="client-notes" placeholder="Es. Allergia a determinati prodotti, preferenze di colore, ecc."></textarea>
          </div>
        </form>
        <div class="actions-row">
          <button type="button" class="btn-sm soft" id="client-reset-btn">
            <span class="icon">üßæ</span><span>Nuova scheda</span>
          </button>
          <button type="button" class="btn-sm danger" id="client-delete-btn">
            <span class="icon">üóëÔ∏è</span><span>Elimina</span>
          </button>
          <button type="button" class="btn-sm primary" id="client-save-btn">
            <span class="icon">üíæ</span><span>Salva cliente</span>
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span>Clienti registrati</span>
              <span class="card-title-pill">Rubrica</span>
            </div>
            <div class="muted">Tocca un cliente per modificarlo o inviare un messaggio WhatsApp.</div>
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;">
          <div style="flex:1;">
            <input type="text" id="client-search" placeholder="Cerca per nome o telefono..." />
          </div>
          <span class="badge-light">Totale: <span id="client-count">0</span></span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Telefono</th>
                <th>Ultima prestazione</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="client-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="page hidden" id="page-appuntamenti">
      <div class="section-title-row">
        <div class="section-title-main">
          <h2>Appuntamenti</h2>
          <span>Pianifica sedute, prezzi e promemoria WhatsApp.</span>
        </div>
        <span class="section-chip">Agenda giornaliera</span>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span>Nuovo appuntamento</span>
              <span class="card-title-pill">Agenda</span>
            </div>
            <div class="muted">Collega un cliente registrato a una seduta, con data, ora e prezzo.</div>
          </div>
        </div>
        <form id="appointment-form">
          <input type="hidden" id="appointment-id" />
          <div>
            <label for="appointment-client">Cliente</label>
            <select id="appointment-client" required>
              <option value="">Seleziona cliente...</option>
            </select>
          </div>
          <div class="field-row-2">
            <div>
              <label for="appointment-date">Data</label>
              <input type="date" id="appointment-date" required />
            </div>
            <div>
              <label for="appointment-time">Ora</label>
              <input type="time" id="appointment-time" required />
            </div>
          </div>
          <div>
            <label for="appointment-service">Servizio</label>
            <input type="text" id="appointment-service" required placeholder="Es. Refill gel + Nail Art" />
          </div>
          <div class="field-row-2">
            <div>
              <label for="appointment-price">Prezzo (‚Ç¨)</label>
              <input type="number" id="appointment-price" min="0" step="0.01" required />
            </div>
            <div>
              <label for="appointment-status">Stato</label>
              <select id="appointment-status">
                <option value="confermato">Confermato</option>
                <option value="effettuato">Effettuato</option>
                <option value="annullato">Annullato</option>
              </select>
            </div>
          </div>
          <div>
            <label for="appointment-notes">Note</label>
            <textarea id="appointment-notes" placeholder="Es. Colore preferito, refil ogni 3 settimane, ecc."></textarea>
          </div>
        </form>
        <div class="actions-row">
          <button type="button" class="btn-sm soft" id="appointment-reset-btn">
            <span class="icon">üßæ</span><span>Nuovo</span>
          </button>
          <button type="button" class="btn-sm danger" id="appointment-delete-btn">
            <span class="icon">üóëÔ∏è</span><span>Elimina</span>
          </button>
          <button type="button" class="btn-sm primary" id="appointment-save-btn">
            <span class="icon">üíæ</span><span>Salva appuntamento</span>
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span>Lista appuntamenti</span>
              <span class="card-title-pill">Panoramica</span>
            </div>
            <div class="muted">Filtra, modifica e invia promemoria WhatsApp per ogni appuntamento.</div>
          </div>
          <span class="badge-light">Totale: <span id="appointment-count">0</span></span>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;">
          <div>
            <label for="appointment-filter-date" style="font-size:0.68rem;color:#a5b4fc;">Da data</label>
            <input type="date" id="appointment-filter-date" />
          </div>
          <div>
            <label for="appointment-filter-status" style="font-size:0.68rem;color:#a5b4fc;">Stato</label>
            <select id="appointment-filter-status">
              <option value="">Tutti</option>
              <option value="confermato">Confermato</option>
              <option value="effettuato">Effettuato</option>
              <option value="annullato">Annullato</option>
            </select>
          </div>
          <button type="button" class="btn-sm soft" id="appointment-filter-reset">
            <span class="icon">‚ôªÔ∏è</span><span>Reset</span>
          </button>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Cliente</th>
                <th>Servizio</th>
                <th>Prezzo</th>
                <th>Stato</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="appointment-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="page hidden" id="page-report">
      <div class="section-title-row">
        <div class="section-title-main">
          <h2>Report & Calendario</h2>
          <span>Incassi per periodo e vista calendario degli appuntamenti.</span>
        </div>
        <span class="section-chip">Analisi</span>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span>Report guadagni</span>
              <span class="card-title-pill">Finanza</span>
            </div>
            <div class="muted">Somma solo gli appuntamenti con stato ‚Äúeffettuato‚Äù.</div>
          </div>
        </div>

        <div class="summary-bar">
          <div class="summary-box">
            <h3>Incasso totale</h3>
            <div class="value" id="report-total">‚Ç¨ 0,00</div>
          </div>
          <div class="summary-box secondary">
            <h3>Appunt. effettuati</h3>
            <div class="value" id="report-done-count">0</div>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;">
          <div>
            <label for="report-year" style="font-size:0.68rem;color:#a5b4fc;">Anno</label>
            <select id="report-year"></select>
          </div>
          <button id="report-reset-year" class="btn-sm soft" type="button">
            <span class="icon">üìÜ</span><span>Tutti gli anni</span>
          </button>
        </div>

        <div style="margin-bottom:6px;">
          <div class="muted" style="margin-bottom:4px;">Totale annuale</div>
          <div id="report-yearly-grid"></div>
        </div>
        <div style="margin-top:8px;">
          <div class="muted" style="margin-bottom:4px;">Dettaglio mensile</div>
          <div id="report-monthly-grid"></div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(30,64,175,0.9);margin:10px 0;" />

        <div>
          <div class="card-header" style="padding:0;margin-bottom:4px;">
            <div>
              <div class="card-title">
                <span>Calendario appuntamenti</span>
                <span class="card-title-pill">Vista weekly / monthly</span>
              </div>
              <div class="muted">Visualizza gli appuntamenti su griglia settimanale o mensile.</div>
            </div>
          </div>
          <div class="calendar-controls">
            <div>
              <label style="font-size:0.68rem;color:#a5b4fc;">Vista</label>
              <div class="calendar-mode-toggle">
                <button type="button" id="calendar-mode-week" class="active">Settimanale</button>
                <button type="button" id="calendar-mode-month">Mensile</button>
              </div>
            </div>
            <div id="calendar-week-wrapper">
              <label for="calendar-week-date" style="font-size:0.68rem;color:#a5b4fc;">Settimana di</label>
              <input type="date" id="calendar-week-date" />
            </div>
            <div id="calendar-month-wrapper" class="hidden">
              <label for="calendar-month" style="font-size:0.68rem;color:#a5b4fc;">Mese</label>
              <input type="month" id="calendar-month" />
            </div>
          </div>

          <div class="calendar-weekdays">
            <div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div>Dom</div>
          </div>
          <div id="calendar-grid" class="calendar-grid"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span>Note operative</span>
              <span class="card-title-pill">Consigli</span>
            </div>
          </div>
        </div>
        <ul class="muted" style="font-size:0.76rem; line-height:1.5; padding-left:16px; margin-top:4px;">
          <li>Installa la PWA da Safari: Condividi ‚Üí Aggiungi alla schermata Home.</li>
          <li>Gli appuntamenti ‚Äúeffettuato‚Äù alimentano i report guadagni.</li>
          <li>Nel calendario vedi tutti gli appuntamenti (confermati, effettuati, annullati).</li>
          <li>Usa la vista settimanale per organizzare la settimana, la vista mensile per le proiezioni.</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <button class="nav-btn active" data-target="page-clienti">
      <span class="nav-btn-icon">üë§</span>
      <span>Clienti</span>
    </button>
    <button class="nav-btn" data-target="page-appuntamenti">
      <span class="nav-btn-icon">üìÖ</span>
      <span>Agenda</span>
    </button>
    <button class="nav-btn" data-target="page-report">
      <span class="nav-btn-icon">üìä</span>
      <span>Report</span>
    </button>
  </div>

  <script>
    (function() {
      const STORAGE_KEYS = {
        clients: 'nt_clients_pwa_v1',
        appointments: 'nt_appointments_pwa_v1'
      };

      function loadArray(key) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          console.error('Errore lettura localStorage', key, e);
          return [];
        }
      }

      function saveArray(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.error('Errore scrittura localStorage', key, e);
          alert('Errore nel salvataggio dei dati sul dispositivo.');
        }
      }

      function uuid() {
        return 'xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      let clients = loadArray(STORAGE_KEYS.clients);
      let appointments = loadArray(STORAGE_KEYS.appointments);

      /* NAVIGAZIONE */
      const pages = {
        'page-clienti': document.getElementById('page-clienti'),
        'page-appuntamenti': document.getElementById('page-appuntamenti'),
        'page-report': document.getElementById('page-report')
      };
      const navButtons = document.querySelectorAll('.nav-btn');
      navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-target');
          Object.keys(pages).forEach(id => {
            pages[id].classList.toggle('hidden', id !== target);
          });
          navButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          if (target === 'page-report') {
            refreshReports();
            renderCalendar();
          }
        });
      });

      /* CLIENTI */
      const clientForm = document.getElementById('client-form');
      const clientIdInput = document.getElementById('client-id');
      const clientNameInput = document.getElementById('client-name');
      const clientPhoneInput = document.getElementById('client-phone');
      const clientEmailInput = document.getElementById('client-email');
      const clientNotesInput = document.getElementById('client-notes');
      const clientLastServiceInput = document.getElementById('client-last-service');
      const clientAddressInput = document.getElementById('client-address');
      const clientTableBody = document.getElementById('client-table-body');
      const clientCountSpan = document.getElementById('client-count');
      const clientSearchInput = document.getElementById('client-search');
      const clientSaveBtn = document.getElementById('client-save-btn');
      const clientResetBtn = document.getElementById('client-reset-btn');
      const clientDeleteBtn = document.getElementById('client-delete-btn');

      function renderClients(filterText) {
        const text = (filterText || '').toLowerCase();
        clientTableBody.innerHTML = '';

        const sorted = [...clients].sort((a, b) => a.name.localeCompare(b.name));
        const filtered = sorted.filter(c => {
          if (!text) return true;
          return (c.name && c.name.toLowerCase().includes(text)) ||
                 (c.phone && c.phone.toLowerCase().includes(text));
        });

        clientCountSpan.textContent = filtered.length.toString();

        filtered.forEach(c => {
          const tr = document.createElement('tr');

          const tdName = document.createElement('td');
          tdName.textContent = c.name || '';
          tr.appendChild(tdName);

          const tdPhone = document.createElement('td');
          tdPhone.textContent = c.phone || '';
          tr.appendChild(tdPhone);

          const tdLastService = document.createElement('td');
          tdLastService.textContent = c.lastService || '';
          tr.appendChild(tdLastService);

          const tdActions = document.createElement('td');

          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'btn-sm soft';
          editBtn.style.fontSize = '0.7rem';
          editBtn.textContent = 'Modifica';
          editBtn.addEventListener('click', () => loadClientIntoForm(c.id));
          tdActions.appendChild(editBtn);

          const waBtn = document.createElement('button');
          waBtn.type = 'button';
          waBtn.className = 'btn-sm primary';
          waBtn.style.fontSize = '0.7rem';
          waBtn.textContent = 'WhatsApp';
          waBtn.addEventListener('click', () => openWhatsAppClient(c));
          tdActions.appendChild(waBtn);

          tr.appendChild(tdActions);
          clientTableBody.appendChild(tr);
        });

        refreshAppointmentClientOptions();
      }

      function resetClientForm() {
        clientIdInput.value = '';
        clientForm.reset();
      }

      function loadClientIntoForm(id) {
        const c = clients.find(x => x.id === id);
        if (!c) return;
        clientIdInput.value = c.id;
        clientNameInput.value = c.name || '';
        clientPhoneInput.value = c.phone || '';
        clientEmailInput.value = c.email || '';
        clientNotesInput.value = c.notes || '';
        clientLastServiceInput.value = c.lastService || '';
        clientAddressInput.value = c.address || '';
      }

      function saveClient() {
        const name = clientNameInput.value.trim();
        const phone = clientPhoneInput.value.trim();

        if (!name || !phone) {
          alert('Nome e telefono sono obbligatori.');
          return;
        }

        const id = clientIdInput.value || uuid();
        const existingIndex = clients.findIndex(c => c.id === id);

        const clientData = {
          id,
          name,
          phone,
          email: clientEmailInput.value.trim(),
          notes: clientNotesInput.value.trim(),
          lastService: clientLastServiceInput.value.trim(),
          address: clientAddressInput.value.trim()
        };

        if (existingIndex >= 0) {
          clients[existingIndex] = clientData;
        } else {
          clients.push(clientData);
        }

        saveArray(STORAGE_KEYS.clients, clients);
        renderClients(clientSearchInput.value);
        clientIdInput.value = id;
        alert('Cliente salvato correttamente.');
      }

      function deleteClient() {
        const id = clientIdInput.value;
        if (!id) {
          alert('Seleziona prima un cliente da eliminare.');
          return;
        }
        if (!confirm('Eliminare questo cliente?')) return;

        const usedInAppointments = appointments.some(a => a.clientId === id);
        if (usedInAppointments) {
          if (!confirm('Questo cliente √® collegato ad alcuni appuntamenti. Vuoi eliminarlo comunque? Gli appuntamenti resteranno ma senza nome cliente.')) {
            return;
          }
        }

        clients = clients.filter(c => c.id !== id);
        saveArray(STORAGE_KEYS.clients, clients);

        appointments = appointments.map(a => {
          if (a.clientId === id) {
            return { ...a, clientId: null };
          }
          return a;
        });
        saveArray(STORAGE_KEYS.appointments, appointments);

        resetClientForm();
        renderClients(clientSearchInput.value);
        renderAppointments();
        alert('Cliente eliminato.');
      }

      function openWhatsAppClient(client) {
        if (!client.phone) {
          alert('Telefono non presente per questo cliente.');
          return;
        }
        const number = client.phone.replace(/[^0-9]/g, '');
        const msg = encodeURIComponent(`Ciao ${client.name || ''}, ti scrivo dallo studio onicotecnico per le tue sedute.`);
        const url = `https://wa.me/${number}?text=${msg}`;
        window.open(url, '_blank');
      }

      clientSaveBtn.addEventListener('click', saveClient);
      clientResetBtn.addEventListener('click', resetClientForm);
      clientDeleteBtn.addEventListener('click', deleteClient);
      clientSearchInput.addEventListener('input', () => renderClients(clientSearchInput.value));

      /* APPUNTAMENTI */
      const appointmentForm = document.getElementById('appointment-form');
      const appointmentIdInput = document.getElementById('appointment-id');
      const appointmentClientSelect = document.getElementById('appointment-client');
      const appointmentDateInput = document.getElementById('appointment-date');
      const appointmentTimeInput = document.getElementById('appointment-time');
      const appointmentServiceInput = document.getElementById('appointment-service');
      const appointmentPriceInput = document.getElementById('appointment-price');
      const appointmentStatusSelect = document.getElementById('appointment-status');
      const appointmentNotesInput = document.getElementById('appointment-notes');

      const appointmentSaveBtn = document.getElementById('appointment-save-btn');
      const appointmentResetBtn = document.getElementById('appointment-reset-btn');
      const appointmentDeleteBtn = document.getElementById('appointment-delete-btn');

      const appointmentFilterDateInput = document.getElementById('appointment-filter-date');
      const appointmentFilterStatusSelect = document.getElementById('appointment-filter-status');
      const appointmentFilterResetBtn = document.getElementById('appointment-filter-reset');

      const appointmentTableBody = document.getElementById('appointment-table-body');
      const appointmentCountSpan = document.getElementById('appointment-count');

      function refreshAppointmentClientOptions() {
        const current = appointmentClientSelect.value;
        appointmentClientSelect.innerHTML = '<option value="">Seleziona cliente...</option>';
        const sorted = [...clients].sort((a, b) => a.name.localeCompare(b.name));
        sorted.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name + (c.phone ? ` (${c.phone})` : '');
          appointmentClientSelect.appendChild(opt);
        });
        if (current) {
          appointmentClientSelect.value = current;
        }
      }

      function resetAppointmentForm() {
        appointmentIdInput.value = '';
        appointmentForm.reset();
      }

      function loadAppointmentIntoForm(id) {
        const a = appointments.find(x => x.id === id);
        if (!a) return;
        appointmentIdInput.value = a.id;
        appointmentClientSelect.value = a.clientId || '';
        appointmentDateInput.value = a.date || '';
        appointmentTimeInput.value = a.time || '';
        appointmentServiceInput.value = a.service || '';
        appointmentPriceInput.value = a.price != null ? a.price : '';
        appointmentStatusSelect.value = a.status || 'confermato';
        appointmentNotesInput.value = a.notes || '';
      }

      function saveAppointment() {
        const clientId = appointmentClientSelect.value;
        const date = appointmentDateInput.value;
        const time = appointmentTimeInput.value;
        const service = appointmentServiceInput.value.trim();
        const priceRaw = appointmentPriceInput.value;

        if (!clientId || !date || !time || !service || !priceRaw) {
          alert('Compila tutti i campi obbligatori.');
          return;
        }

        const price = parseFloat(priceRaw);
        if (isNaN(price) || price < 0) {
          alert('Inserisci un prezzo valido.');
          return;
        }

        const id = appointmentIdInput.value || uuid();
        const existingIndex = appointments.findIndex(a => a.id === id);

        const appData = {
          id,
          clientId,
          date,
          time,
          service,
          price,
          status: appointmentStatusSelect.value || 'confermato',
          notes: appointmentNotesInput.value.trim()
        };

        if (existingIndex >= 0) {
          appointments[existingIndex] = appData;
        } else {
          appointments.push(appData);
        }

        saveArray(STORAGE_KEYS.appointments, appointments);
        renderAppointments();
        appointmentIdInput.value = id;
        alert('Appuntamento salvato correttamente.');
      }

      function deleteAppointment() {
        const id = appointmentIdInput.value;
        if (!id) {
          alert('Seleziona prima un appuntamento da eliminare.');
          return;
        }
        if (!confirm('Eliminare questo appuntamento?')) return;

        appointments = appointments.filter(a => a.id !== id);
        saveArray(STORAGE_KEYS.appointments, appointments);
        resetAppointmentForm();
        renderAppointments();
        alert('Appuntamento eliminato.');
      }

      function getClientNameById(id) {
        if (!id) return '(cliente eliminato)';
        const c = clients.find(x => x.id === id);
        return c ? c.name : '(cliente eliminato)';
      }

      function getClientPhoneById(id) {
        if (!id) return '';
        const c = clients.find(x => x.id === id);
        return c ? (c.phone || '') : '';
      }

      function openWhatsAppAppointment(app) {
        const clientName = getClientNameById(app.clientId);
        const phone = getClientPhoneById(app.clientId);
        if (!phone) {
          alert('Telefono non presente per il cliente di questo appuntamento.');
          return;
        }
        const number = phone.replace(/[^0-9]/g, '');
        const date = app.date || '';
        const time = app.time || '';
        const msg = encodeURIComponent(
          `Ciao ${clientName}, ti ricordo il tuo appuntamento presso lo studio onicotecnico:\n` +
          `üìÖ Data: ${date}\n` +
          `‚è∞ Ora: ${time}\n` +
          `üíÖ Servizio: ${app.service}\n\n` +
          `Se hai bisogno di modificare o spostare l'appuntamento rispondi pure a questo messaggio.`
        );
        const url = `https://wa.me/${number}?text=${msg}`;
        window.open(url, '_blank');
      }

      function renderAppointments() {
        appointmentTableBody.innerHTML = '';

        let filtered = [...appointments];

        const dateFilter = appointmentFilterDateInput.value;
        const statusFilter = appointmentFilterStatusSelect.value;

        if (dateFilter) {
          filtered = filtered.filter(a => a.date >= dateFilter);
        }
        if (statusFilter) {
          filtered = filtered.filter(a => a.status === statusFilter);
        }

        filtered.sort((a, b) => {
          const keyA = (a.date || '') + ' ' + (a.time || '');
          const keyB = (b.date || '') + ' ' + (b.time || '');
          return keyA.localeCompare(keyB);
        });

        appointmentCountSpan.textContent = filtered.length.toString();

        filtered.forEach(a => {
          const tr = document.createElement('tr');

          const tdDate = document.createElement('td');
          tdDate.textContent = (a.date || '') + (a.time ? ' ' + a.time : '');
          tr.appendChild(tdDate);

          const tdClient = document.createElement('td');
          tdClient.textContent = getClientNameById(a.clientId);
          tr.appendChild(tdClient);

          const tdService = document.createElement('td');
          tdService.textContent = a.service || '';
          tr.appendChild(tdService);

          const tdPrice = document.createElement('td');
          tdPrice.textContent = a.price != null ? '‚Ç¨ ' + a.price.toFixed(2) : '';
          tr.appendChild(tdPrice);

          const tdStatus = document.createElement('td');
          const statusSpan = document.createElement('span');
          statusSpan.className = 'status-badge';
          if (a.status === 'confermato') {
            statusSpan.classList.add('pending');
            statusSpan.textContent = 'Confermato';
          } else if (a.status === 'effettuato') {
            statusSpan.textContent = 'Effettuato';
          } else {
            statusSpan.classList.add('cancelled');
            statusSpan.textContent = 'Annullato';
          }
          tdStatus.appendChild(statusSpan);
          tr.appendChild(tdStatus);

          const tdActions = document.createElement('td');

          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'btn-sm soft';
          editBtn.style.fontSize = '0.7rem';
          editBtn.textContent = 'Modifica';
          editBtn.addEventListener('click', () => {
            loadAppointmentIntoForm(a.id);
          });
          tdActions.appendChild(editBtn);

          const waBtn = document.createElement('button');
          waBtn.type = 'button';
          waBtn.className = 'btn-sm primary';
          waBtn.style.fontSize = '0.7rem';
          waBtn.textContent = 'WhatsApp';
          waBtn.addEventListener('click', () => openWhatsAppAppointment(a));
          tdActions.appendChild(waBtn);

          tr.appendChild(tdActions);
          appointmentTableBody.appendChild(tr);
        });

        refreshReports();
        renderCalendar();
      }

      appointmentSaveBtn.addEventListener('click', saveAppointment);
      appointmentResetBtn.addEventListener('click', resetAppointmentForm);
      appointmentDeleteBtn.addEventListener('click', deleteAppointment);

      appointmentFilterDateInput.addEventListener('change', renderAppointments);
      appointmentFilterStatusSelect.addEventListener('change', renderAppointments);
      appointmentFilterResetBtn.addEventListener('click', () => {
        appointmentFilterDateInput.value = '';
        appointmentFilterStatusSelect.value = '';
        renderAppointments();
      });

      /* REPORT */
      const reportTotalSpan = document.getElementById('report-total');
      const reportDoneCountSpan = document.getElementById('report-done-count');
      const reportYearSelect = document.getElementById('report-year');
      const reportResetYearBtn = document.getElementById('report-reset-year');
      const reportYearlyGrid = document.getElementById('report-yearly-grid');
      const reportMonthlyGrid = document.getElementById('report-monthly-grid');

      function buildReportsData() {
        const done = appointments.filter(a => a.status === 'effettuato');
        let grandTotal = 0;
        let doneCount = done.length;

        const byYear = {};
        const byYearMonth = {};

        done.forEach(a => {
          const date = a.date || '';
          if (!date || !a.price) return;
          const year = date.slice(0,4);
          const month = date.slice(0,7);
          const price = Number(a.price) || 0;

          grandTotal += price;

          if (!byYear[year]) byYear[year] = 0;
          byYear[year] += price;

          if (!byYearMonth[month]) byYearMonth[month] = 0;
          byYearMonth[month] += price;
        });

        return { grandTotal, doneCount, byYear, byYearMonth };
      }

      function refreshReportYearOptions() {
        const years = new Set();
        appointments.forEach(a => {
          if (a.date) years.add(a.date.slice(0,4));
        });
        const sorted = Array.from(years).sort();
        reportYearSelect.innerHTML = '<option value="">Tutti</option>';
        sorted.forEach(y => {
          const opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y;
          reportYearSelect.appendChild(opt);
        });
      }

      function refreshReports() {
        const { grandTotal, doneCount, byYear, byYearMonth } = buildReportsData();

        reportTotalSpan.textContent = '‚Ç¨ ' + grandTotal.toFixed(2);
        reportDoneCountSpan.textContent = doneCount.toString();

        refreshReportYearOptions();
        const selectedYear = reportYearSelect.value || '';

        reportYearlyGrid.innerHTML = '';
        const yearlyEntries = Object.entries(byYear).sort((a, b) => a[0].localeCompare(b[0]));
        yearlyEntries.forEach(([year, total]) => {
          if (selectedYear && year !== selectedYear) return;
          const div = document.createElement('div');
          div.className = 'report-card';
          const label = document.createElement('span');
          label.textContent = year;
          const value = document.createElement('span');
          value.className = 'value';
          value.textContent = '‚Ç¨ ' + total.toFixed(2);
          div.appendChild(label);
          div.appendChild(value);
          reportYearlyGrid.appendChild(div);
        });

        reportMonthlyGrid.innerHTML = '';
        const monthlyEntries = Object.entries(byYearMonth).sort((a, b) => a[0].localeCompare(b[0]));
        monthlyEntries.forEach(([ym, total]) => {
          const y = ym.slice(0,4);
          if (selectedYear && y !== selectedYear) return;
          const [year, month] = ym.split('-');
          const monthLabel = month + '/' + year;
          const div = document.createElement('div');
          div.className = 'report-card';
          const label = document.createElement('span');
          label.textContent = monthLabel;
          const value = document.createElement('span');
          value.className = 'value';
          value.textContent = '‚Ç¨ ' + total.toFixed(2);
          div.appendChild(label);
          div.appendChild(value);
          reportMonthlyGrid.appendChild(div);
        });
      }

      reportYearSelect.addEventListener('change', () => {
        refreshReports();
        renderCalendar();
      });
      reportResetYearBtn.addEventListener('click', () => {
        reportYearSelect.value = '';
        refreshReports();
        renderCalendar();
      });

      /* CALENDARIO */
      const calendarModeWeekBtn = document.getElementById('calendar-mode-week');
      const calendarModeMonthBtn = document.getElementById('calendar-mode-month');
      const calendarWeekWrapper = document.getElementById('calendar-week-wrapper');
      const calendarMonthWrapper = document.getElementById('calendar-month-wrapper');
      const calendarWeekDateInput = document.getElementById('calendar-week-date');
      const calendarMonthInput = document.getElementById('calendar-month');
      const calendarGrid = document.getElementById('calendar-grid');
      let calendarMode = 'week';

      function setTodayDefaults() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');
        if (!calendarWeekDateInput.value) {
          calendarWeekDateInput.value = `${yyyy}-${mm}-${dd}`;
        }
        if (!calendarMonthInput.value) {
          calendarMonthInput.value = `${yyyy}-${mm}`;
        }
      }

      function getAppointmentsByDateMap() {
        const map = {};
        appointments.forEach(a => {
          if (!a.date) return;
          if (!map[a.date]) map[a.date] = [];
          map[a.date].push(a);
        });
        Object.keys(map).forEach(k => {
          map[k].sort((a,b) => (a.time||'').localeCompare(b.time||''));
        });
        return map;
      }

      function renderCalendar() {
        setTodayDefaults();
        const map = getAppointmentsByDateMap();
        calendarGrid.innerHTML = '';

        if (calendarMode === 'week') {
          const refStr = calendarWeekDateInput.value;
          if (!refStr) return;
          const parts = refStr.split('-');
          if (parts.length !== 3) return;
          const y = Number(parts[0]);
          const m = Number(parts[1]);
          const d = Number(parts[2]);
          if (!y || !m || !d) return;
          let refDate = new Date(y, m-1, d);
          let day = refDate.getDay(); // 0=Dom
          let diff = (day + 6) % 7;   // distanza da luned√¨
          const monday = new Date(refDate);
          monday.setDate(refDate.getDate() - diff);

          for (let i=0;i<7;i++) {
            const current = new Date(monday);
            current.setDate(monday.getDate() + i);
            const yyyy = current.getFullYear();
            const mm = String(current.getMonth()+1).padStart(2,'0');
            const dd = String(current.getDate()).padStart(2,'0');
            const key = `${yyyy}-${mm}-${dd}`;

            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';

            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            const dateSpan = document.createElement('span');
            dateSpan.className = 'date';
            dateSpan.textContent = dd;
            header.appendChild(dateSpan);
            dayDiv.appendChild(header);

            const body = document.createElement('div');
            body.className = 'calendar-day-body';

            const apps = map[key] || [];
            apps.forEach(a => {
              const row = document.createElement('div');
              row.className = 'calendar-appointment';
              const dot = document.createElement('span');
              dot.className = 'dot';
              row.appendChild(dot);
              const txt = document.createTextNode(`${a.time || ''} ${getClientNameById(a.clientId)} ‚Äì ${a.service}`);
              row.appendChild(txt);
              body.appendChild(row);
            });

            dayDiv.appendChild(body);
            calendarGrid.appendChild(dayDiv);
          }
        } else {
          const monthStr = calendarMonthInput.value;
          if (!monthStr) return;
          const parts = monthStr.split('-');
          if (parts.length !== 2) return;
          const y = Number(parts[0]);
          const m = Number(parts[1]);
          if (!y || !m) return;

          const firstDay = new Date(y, m-1, 1);
          const lastDay = new Date(y, m, 0);
          const firstWeekday = (firstDay.getDay() + 6) % 7; // 0=Lun
          const daysInMonth = lastDay.getDate();
          const totalCells = Math.ceil((firstWeekday + daysInMonth)/7)*7;

          for (let cell=0;cell<totalCells;cell++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';

            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            const dateSpan = document.createElement('span');
            dateSpan.className = 'date';

            const dayNum = cell - firstWeekday + 1;
            let key = null;
            if (dayNum >= 1 && dayNum <= daysInMonth) {
              const dd = String(dayNum).padStart(2,'0');
              const mm = String(m).padStart(2,'0');
              key = `${y}-${mm}-${dd}`;
              dateSpan.textContent = dd;
            } else {
              dateSpan.textContent = '';
              dayDiv.style.opacity = 0.32;
            }
            header.appendChild(dateSpan);
            dayDiv.appendChild(header);

            const body = document.createElement('div');
            body.className = 'calendar-day-body';

            if (key && map[key]) {
              map[key].forEach(a => {
                const row = document.createElement('div');
                row.className = 'calendar-appointment';
                const dot = document.createElement('span');
                dot.className = 'dot';
                row.appendChild(dot);
                const txt = document.createTextNode(`${a.time || ''} ${getClientNameById(a.clientId)} ‚Äì ${a.service}`);
                row.appendChild(txt);
                body.appendChild(row);
              });
            }

            dayDiv.appendChild(body);
            calendarGrid.appendChild(dayDiv);
          }
        }
      }

      calendarModeWeekBtn.addEventListener('click', () => {
        calendarMode = 'week';
        calendarModeWeekBtn.classList.add('active');
        calendarModeMonthBtn.classList.remove('active');
        calendarWeekWrapper.classList.remove('hidden');
        calendarMonthWrapper.classList.add('hidden');
        renderCalendar();
      });

      calendarModeMonthBtn.addEventListener('click', () => {
        calendarMode = 'month';
        calendarModeMonthBtn.classList.add('active');
        calendarModeWeekBtn.classList.remove('active');
        calendarMonthWrapper.classList.remove('hidden');
        calendarWeekWrapper.classList.add('hidden');
        renderCalendar();
      });

      calendarWeekDateInput.addEventListener('change', renderCalendar);
      calendarMonthInput.addEventListener('change', renderCalendar);

      /* INIT */
      renderClients('');
      renderAppointments();
      setTodayDefaults();
      renderCalendar();
    })();
  </script>
</body>
</html>
